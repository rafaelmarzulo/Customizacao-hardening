# Makefile para automa√ß√£o do projeto

.PHONY: help install test lint clean backup setup-dev

# Vari√°veis
PROJECT_NAME := customizacao-hardening
INSTALL_DIR := /opt/$(PROJECT_NAME)
CONFIG_DIR := /etc/$(PROJECT_NAME)
LOG_DIR := /var/log/$(PROJECT_NAME)

# Ajuda
help:
	@echo "Comandos dispon√≠veis:"
	@echo "  test-dev    - Testa execu√ß√£o direta dos scripts de desenvolvimento"
	@echo "  install     - Instalar o projeto no sistema"
	@echo "  test        - Executar testes"
	@echo "  lint        - Verificar qualidade do c√≥digo"
	@echo "  clean       - Limpar arquivos tempor√°rios"
	@echo "  backup      - Fazer backup das configura√ß√µes"
	@echo "  setup-dev   - Configurar ambiente de desenvolvimento"

# Instala√ß√£o
install:
	@echo "Instalando $(PROJECT_NAME)..."
	sudo mkdir -p $(INSTALL_DIR) $(CONFIG_DIR) $(LOG_DIR)
	sudo cp -r scripts/ $(INSTALL_DIR)/
	sudo cp -r configs/ $(CONFIG_DIR)/
	sudo chmod +x $(INSTALL_DIR)/scripts/*/*.sh
	sudo ln -sf $(INSTALL_DIR)/scripts/hardening/ssh_hardening.sh /usr/local/bin/ssh-hardening
	sudo ln -sf $(INSTALL_DIR)/scripts/setup/server_setup.sh /usr/local/bin/server-setup
	@echo "Instala√ß√£o conclu√≠da!"

# Testes
test:
	@echo "Executando testes..."
	./tests/test_runner.sh

# Verifica√ß√£o de qualidade
lint:
	@echo "Verificando qualidade do c√≥digo..."
	find scripts/ -name "*.sh" -exec shellcheck {} \;

# Limpeza
clean:
	@echo "Limpando arquivos tempor√°rios..."
	find . -name "*.tmp" -delete
	find . -name "*.log" -delete

# Backup
backup:
	@echo "Fazendo backup das configura√ß√µes..."
	tar -czf backup-$(shell date +%Y%m%d_%H%M%S).tar.gz configs/ scripts/

# Configurar ambiente de desenvolvimento
setup-dev:
	@echo "Configurando ambiente de desenvolvimento..."
	sudo apt update
	sudo apt install -y shellcheck yamllint
	pip3 install pre-commit
	pre-commit install


# Teste de execu√ß√£o direta dos scripts no modo desenvolvimento
test-dev:
	@echo "üîç Testando execu√ß√£o direta dos scripts (modo desenvolvimento)..."

	@echo "‚û°Ô∏è  Testando: scripts/hardening/ssh_hardening.sh"
	@bash scripts/hardening/ssh_hardening.sh --help || echo "‚ö†Ô∏è  Ignorando erro esperado se n√£o houver --help implementado."

	@echo "‚û°Ô∏è  Testando: scripts/setup/server_setup.sh"
	@bash scripts/setup/server_setup.sh --help || echo "‚ö†Ô∏è  Ignorando erro esperado se n√£o houver --help implementado."

	@echo "‚úÖ Teste de execu√ß√£o direta conclu√≠do!"